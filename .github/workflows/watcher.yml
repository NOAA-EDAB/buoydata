name: Retry ERDDAP on Failure
on:
  workflow_run:
    # Trigger on the completion of the main workflow
    workflows: ["ERDDAPâ„¢"]
    types: [completed]

jobs:
  restart_if_needed:
    runs-on: ubuntu-latest
    # Check if the overall outcome of the main workflow was 'failure' or 'cancelled' (aborted)
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'cancelled' }}
    permissions:
      actions: write
    steps:
      - name: Check Conclusion
        run: |
          echo "Previous workflow concluded with: ${{ github.event.workflow_run.conclusion }}. Restarting main job."
        shell: bash

      - name: Dispatch New Workflow Run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // This script calls the GitHub API to trigger a new run of the 'erddap data pull'
            console.log("Main workflow failed. Triggering a retry...");
            github.rest.actions.create_workflow_dispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'your_main_filename.yml', # Replace with your ACTUAL filename (e.g., main.yml)
              ref: 'main'
            });

